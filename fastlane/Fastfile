opt_out_usage

default_platform(:ios)

APP_IDENTIFIER = "me.proton.mail.ios"
DEVELOPER_KEYCHAIN_NAME = "PROTONMAIL_IOS_CERTIFICATE_KEYCHAIN"
DEVELOPER_KEYCHAIN_PASSWORD = "QrniqyS3LWTH3Ji"
API_KEY_DURATION = 20 * 60 # 20 mins
CERTIFICATE_PATH = "fastlane/Certificates.p12"
XCODEPROJ = "ProtonMail.xcodeproj"
APP_TARGET = "ProtonMail"
UNIT_TESTS_SCHEME = "AllUnitAndSnapshotTests"
UI_TESTS_SCHEME = "ProtonMailUITest"
UI_TESTS_DEVICE = "iPhone 15 Pro"
UNIT_TESTS_DEVICE = "iPhone 15 Pro"
XCODEGEN_CONFIGURATION_FILE_PATH = "../project.yml"

CONCURRENT_WORKERS=2
MAX_CONCURRENT_SIMULATORS=2
SMOKE_PLAN_NAME="SmokeTests"
REGRESSION_PLAN_NAME="RegressionTests"

platform :ios do
  def set_up_keychain
    create_keychain(
        name: DEVELOPER_KEYCHAIN_NAME,
        password: DEVELOPER_KEYCHAIN_PASSWORD,
        default_keychain: false,
        add_to_search_list: true,
        unlock: true,
        timeout: 3600
    )
    import_certificate(
        keychain_name: DEVELOPER_KEYCHAIN_NAME,
        keychain_password: DEVELOPER_KEYCHAIN_PASSWORD,
        certificate_path: CERTIFICATE_PATH,
        certificate_password: ENV["DISTRIBUTION_CERTIFICATE_PASSWORD"]
    )
  end

  def tear_down_keychain
    delete_keychain(
        name: DEVELOPER_KEYCHAIN_NAME
    )
  end

  def set_up_app_store_api_key
    app_store_connect_api_key(
      key_id: ENV["APPSTORE_API_KEY_ID"],
      issuer_id: ENV["APPSTORE_API_KEY_ISSUER"],
      key_content: ENV["APPSTORE_API_KEY"],
      duration: API_KEY_DURATION,
      in_house: false
    )
  end

  def get_xcode_profile(api_key)
    ids = [
      APP_IDENTIFIER,
    ]

    ids.each do |id|
      get_provisioning_profile(
        app_identifier: id,
        api_key: api_key,
        readonly: true,
      )
    end
  end

  def get_latest_build_number(api_key)
    latest_testflight_build_number(
      api_key: api_key, 
      app_identifier: APP_IDENTIFIER,
      version: get_version_number(xcodeproj: XCODEPROJ, target: APP_TARGET)
    )
  end 

  def generate_new_build_number(latest_build_number)
    latest_build_number == 1 ? latest_build_number : latest_build_number + 1
  end

  def current_marketing_version
    sh("sed -n 's/.*MARKETING_VERSION: \\(.*\\)/\\1/p' #{XCODEGEN_CONFIGURATION_FILE_PATH}").strip
  end

  def bump_build_number_in_xcodegen_configuration(new_build_number)
    sh("sed -i '' -e 's/^\\( *CURRENT_PROJECT_VERSION: \\).*/\\1#{new_build_number}/' #{XCODEGEN_CONFIGURATION_FILE_PATH}").strip
  end

  def commit_add_tag_and_push(build_number)
    project_version = current_marketing_version
    branch_name = ENV['CI_COMMIT_REF_NAME']

    sh("git fetch origin #{branch_name}:#{branch_name}")
    sh("git checkout #{branch_name}")

    bump_build_number_in_xcodegen_configuration(build_number)
    git_add(path: "./project.yml")
    git_commit(path: "./project.yml", message: "Bump the project v#{project_version}_#{build_number} [ci skip]")
    add_git_tag(tag: "v#{project_version}_#{build_number}")
    push_to_git_remote
  end

  lane :decode_distribution_certificate do
    sh "base64 -D -o Certificates.p12 <<< $DISTRIBUTION_CERTIFICATE"
  end

  desc "Build the app"
  # Skip archiving and codesigning, until provisioning is properly set.
  lane :build do
    build_app(
      scheme: "ProtonMail",
      configuration: "Release",
      skip_codesigning: true,
      clean: true,
      skip_archive: true,
      xcargs: "-skipPackagePluginValidation"
    )
  end

  desc "Build the release app"
  lane :build_release_app do
    build_app(
      scheme: "ProtonMail",
      clean: true,
      output_directory: "outputs/",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "me.proton.mail.ios" => "Mail - Engineering Transformation Distribution",
        }
      },
      xcargs: "-skipPackagePluginValidation"
    )
  end

  desc "Run unit tests"
  lane :tests do
    run_tests(
      scheme: UNIT_TESTS_SCHEME,
      devices: UNIT_TESTS_DEVICE,
      prelaunch_simulator: true,
      reset_simulator: true,
      result_bundle: true,
      parallel_testing: false,
      xcargs: "-skipPackagePluginValidation"
    )
  end

  desc "Setup UI Tests assets"
    lane :setup_uitests_assets do
    sh("../scripts/uitests/setup-mock-network-assets.sh setup-remote")
    sh("../xcodegen/bin/xcodegen -s ../project.yml") # We need to do it another time to include UI tests assets.
  end

  desc "Run UI Smoke Tests"
  lane :uitests_smoke do
      run_tests(
        scheme: UI_TESTS_SCHEME,
        devices: UI_TESTS_DEVICE,
        max_concurrent_simulators: MAX_CONCURRENT_SIMULATORS,
        concurrent_workers: CONCURRENT_WORKERS,
        include_simulator_logs: true,
        prelaunch_simulator: true,
        reset_simulator: true,
        result_bundle: true,
        testplan: SMOKE_PLAN_NAME,
        xcargs: "-skipPackagePluginValidation"
      )
  end

  desc "Run UI Full Regression Tests"
    lane :uitests_full_regression do
      run_tests(
        scheme: UI_TESTS_SCHEME,
        devices: UI_TESTS_DEVICE,
        max_concurrent_simulators: MAX_CONCURRENT_SIMULATORS,
        concurrent_workers: CONCURRENT_WORKERS,
        include_simulator_logs: true,
        prelaunch_simulator: true,
        reset_simulator: true,
        result_bundle: true,
        testplan: REGRESSION_PLAN_NAME,
        xcargs: "-skipPackagePluginValidation"
      )
  end

  desc "Deploy to Test Flight"
  lane :deploy do 
    begin
      decode_distribution_certificate
      set_up_keychain

      api_key = set_up_app_store_api_key
      get_xcode_profile(api_key)

      latest_build_number = get_latest_build_number(api_key)
      new_build_number = generate_new_build_number(latest_build_number)
      increment_build_number(build_number: new_build_number)

      build_release_app

      upload_to_testflight(
        api_key: api_key,
        team_name: "Proton Technologies AG",
        skip_waiting_for_build_processing: true
      )

      commit_add_tag_and_push(new_build_number)
    ensure
      tear_down_keychain
    end
  end
end
